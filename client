import socket
import sys
import bcrypt
import json
import os
import base64
import threading

from prettytable import PrettyTable

if len(sys.argv) != 2:
    print("Usage: python client.py <port>")
    sys.exit(1)

server_domain = "127.0.0.1"
server_port = int(sys.argv[1]) 

client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

def connect():
    try:
        client_socket.connect((server_domain, server_port))
        print("Connected successfully.")
    except socket.error as e:
        print(f"Connection failed: {e}")
        
def send_request(data):
    client_socket.sendall(str(data).encode("utf-8"))
    response = client_socket.recv(1024).decode("utf-8")
    return response

def password_check(passwd):
    SpecialSym = ['$', '@', '#', '%']
    if len(passwd) < 6:
        print('Length should be at least 6.')
        return False
    if not any(char.isdigit() for char in passwd):
        print('Password should have at least one numeral.')
        return False
    if not any(char.isupper() for char in passwd):
        print('Password should have at least one uppercase letter.')
        return False
    if not any(char.islower() for char in passwd):
        print('Password should have at least one lowercase letter.')
        return False
    if not any(char in SpecialSym for char in passwd):
        print('Password should have at least one of the symbols $@#.')
        return False
    return True

def register():
    name = input("Enter name: ")
    email = input("Enter email: ")
    if '@' not in email or '.' not in email.split('@')[-1]:
        print("Invalid email format.")
        return
    address=input("Enter your address: ")
    username = input("Enter username: ")
    password = input("Enter your password (at least 6 characters, at least one numeral, "
                     "one uppercase letter, one lowercase letter, and one of the symbols $@#): ")

    if not password_check(password):
        return

    try:
        password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
    except Exception as e:
        print(f"Error in hashing password: {e}")
        return
    
    data = {
        "action": "register",
        "name": name,
        "email": email,
        "address":address,
        "username": username,
        "password": password_hash.decode()
    }
    
    response = send_request(data)
    print(response["response"])
    
def login():
    username = input("Enter username: ")
    password = input("Enter password: ")

    data = {
        "action": "login",
        "username": username,
        "password": password
    }
    response = send_request(data)
    if response and response.get("response") == "Logged in successfully!":
        print("You are logged in!")
        display_products(response.get("products", []))
    else:
        print(response.get("response", "Login failed."))

def display_products(products):
    if products:
        table = PrettyTable(["Product Name", "Price ($)", "Description", "Image", "Owner"])
        for product in products:
            table.add_row([product['name'], product['price'], product['description'], product['picture'], product['owner']])
        print("\nProducts for Sale:")
        print(table)
    else:
        print("No products available for sale.")

def view_products_by_owner():
    owner = input("Enter the owner's username to view their products: ")
    data = {"action": "VIEW_PRODUCTS_BY_OWNER", "owner": owner}
    
    response = send_request(data)
    products = response.get("products", [])
    
    table = PrettyTable()
    table.field_names = ["Product Name", "Price (in $)", "Description", "Image","Owner"]
    
    for product in products:
        table.add_row([product['name'], product['price'], product['description'], product['picture'], product['owner']])
    
    print(f"Products from {owner}:")
    print(table)
#def view_products_by_owner():
  #  owner = input("Enter the owner's username: ")
   # response = send_request({"action": "VIEW_PRODUCTS_BY_OWNER", "owner": owner})
  #  display_products(response.get("products", []))
    
def check_owner_status():
    owner = input("Enter the owner's username to check their online status: ")
    data = {"action": "CHECK_OWNER_STATUS", "owner": owner}
    
    response = send_request(data)

    # Optional: Check for success or failure in the response
    if "message" in response:
        print(response["message"])
    else:
        print("Error checking owner status.")
    
def add_product():
    name = input("Enter product name: ")
    description = input("Enter product description: ")
    price = float(input("Enter product price: "))
    image_path = input("Enter image path: ")
    
    if os.path.isfile(image_path):
        with open(image_path, 'rb') as f:
            image_data = f.read()
            image_base64 = base64.b64encode(image_data).decode()
    else:
        print("Image file does not exist.")
        return
    
    data = {
        "action": "ADD_PRODUCT",
        "name": name,
        "description": description,
        "price": price,
        "image": image_base64
    }
    
    response = send_request(data)
    print(response["message"])
    
def chat_with_owner(owner):
    print(f"Starting a chat with {owner}. Type 'exit' to end the chat.")
    while True:
        message = input("You: ")
        if message.lower() == 'exit':
            break
        data = {
            "action": "chat",
            "owner": owner,
            "message": message
        }
        response = send_request(data)
        print(f"Response from {owner}: {response['response']}")

def receive_messages():
    while True:
        try:
            message = client_socket.recv(1024).decode('utf-8')
            if message:
                message_data = json.loads(message)
                print(f"{message_data['from']}: {message_data['message']}")
            else:
                break
        except ConnectionResetError:
            print("Connection lost.")
            break
        except Exception as e:
            print(f'An error occurred: {e}')
            break

def send_message():
    while True:
        recipient = input("Enter recipient username: ")
        message = input("Enter message: ")
        data = json.dumps({"action": "chat", "owner": recipient, "message": message})
        client_socket.send(data.encode('utf-8'))

# Start the threads for receiving and sending messages
receive_thread = threading.Thread(target=receive_messages, daemon=True)
receive_thread.start()

send_thread = threading.Thread(target=send_message, daemon=True)
send_thread.start()
try:
    while True:
        pass  # Or handle other application logic
except KeyboardInterrupt:
    print("Exiting chat.")
    client_socket.close()
        
def buy_product():
    product_name = input("Enter the product name to buy: ")
    data = {"action": "BUY_PRODUCT", "product_name": product_name}
    response = send_request(data)
    print(response["message"])
    
def view_buyers():
    username = input("Enter your username to view buyers: ")
    data = {"action": "VIEW_BUYERS", "username": username}
    response = send_request(data)
    
    buyers = response.get("buyers", [])
    if buyers:
        print("Buyers of your products:")
        for buyer in buyers:
            print(buyer)
    else:
        print("No buyers found.")

def logout():
    """Function to log out the user from the application."""
    client_socket.sendall("LOGOUT".encode('utf-8'))
    response = client_socket.recv(1024).decode('utf-8')
    client_socket.close()
    print(response)


def main():
    connect()
    while True:
        choice = input("\nChoose: [r]egister, [l]ogin ").lower()
        if choice == 'r':
            register()
        elif choice == 'l':
            login()
            homepage()
        else:
            print("Invalid choice. Please choose [r], [l], or [q].")
            
if __name__ == "__main__":
    main()
    
def homepage():
    while True:
        print("\n--- Homepage ---")
        print("1. Check product owner online status")
        print("2. Add a Product")
        print("3. View Products by Owner")
        print("4. Buy a Product")
        print("5. View Buyers")
        print("6. Log Out")

        choice = input("Choose an option: ")

        if choice == "1":
            check_owner_status()
        elif choice == "2":
            add_product()
        elif choice == "3":
            view_products_by_owner()
        elif choice == "4":
            buy_product()
        elif choice == "5":
            view_buyers()
        elif choice == "6":
            print("Logging out...")
            logout()
            break
        else:
            print("Invalid choice. Please try again.")

